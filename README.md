# Resume · 智能简历平台

> 一体化的所见即所得简历工作台：离线/在线统一存储、Automerge 实时协作、可定制模板主题。

- 在线演示（Demo）：**[https://506resume.vercel.app/](https://506resume.vercel.app/)**

## 🥁 最新进展

- **Automerge + Supabase 双引擎协作**：自研 `SupabaseNetworkAdapter`，通过 Realtime 频道传输 Automerge diff，支持分享链接、角色管理、实时光标与协作者在线状态。
- **离线/云端一体化简历库**：新的仪表盘整合 IndexedDB 草稿与云端文档，提供批量同步、选择性迁移、远程删除同步提示。
- **模块化编辑体验升级**：Tiptap 3 富文本 + 12 个语义区块表单，支持拖拽排序、按模块隐藏、主题/字体/间距实时预览。
- **账号与偏好中心**：接入 Supabase Auth 登录注册、忘记密码跳转、个人资料页与环境变量健康检查。

## ✨ 核心特性

- **WYSIWYG 简历编辑器**：侧边抽屉驱动的区块表单 + 实时预览，覆盖个人信息、教育/工作/实习、项目、技能、荣誉、自我评价等模块；内置富文本能力（高亮、列表、图片、对齐等）。
- **实时协作**：Automerge 文档驱动的数据层，点击一键生成分享链接，协作人数、角色、光标位置与颜色实时可视。
- **离线优先与容灾**：所有草稿自动落盘到 IndexedDB，断网继续编辑；恢复网络后自动回放更改，也可手动触发同步。
- **同步与版本守护**：字段级合并策略 + 删除优先，云端保存 Automerge 快照与 heads，确保新会话立即对齐；远端删除时提供 toast 提示与跳转。
- **可扩展模板系统**：JSON Schema + Zustand 配置器定义字段、默认值、主题；Preview 组件支持主题色、字体、间距等即刻切换。
- **工程化体验**：Vite 7 + React 19 + Tailwind CSS v4 + pnpm，配合 shadcn/ui、motion、lucide/Tabler 图标，快速开发与迭代。

## 🧱 技术栈

- **前端框架**：React 19 · Vite 7 · React Router 7
- **编辑器与 UI**：Tiptap 3 · Tailwind CSS 4 · shadcn/ui · motion · lucide-react
- **状态管理**：Zustand · React Hook Form · Zod
- **协作与数据层**：Automerge Repo · IndexedDB Storage · Supabase (Auth / Postgres / Realtime)
- **工具链**：TypeScript 5.9 · ESLint 9 · Prettier 3 · pnpm

## 📦 目录结构

```
.
├─ public/                        # 静态资源
├─ src/
│  ├─ components/                 # 通用 UI、业务组件（协作面板、抽屉、光标等）
│  ├─ contexts/                   # 全局上下文（拖拽、协作面板）
│  ├─ hooks/                      # 自定义 hooks（实时光标、设备检测等）
│  ├─ lib/
│  │  ├─ automerge/               # Automerge 文档管理、Supabase 网络适配器
│  │  ├─ collaboration/           # 协作会话本地缓存 & 工具
│  │  ├─ supabase/                # Supabase 客户端、数据访问层
│  │  ├─ schema/                  # JSON Schema、默认值、类型定义
│  │  ├─ offline-resume-manager.ts# IndexedDB 数据层
│  │  └─ resume-sync-service.ts   # 离线 → 云端同步服务
│  ├─ pages/                      # 路由页面（登录、注册、仪表盘、编辑器、个人中心等）
│  ├─ store/                      # Zustand 状态仓库
│  ├─ styles/                     # Tailwind & 全局样式
│  ├─ App.tsx
│  ├─ main.tsx
│  └─ index.css
├─ package.json
├─ pnpm-lock.yaml
├─ vite.config.ts
├─ vercel.json
└─ README.md
```

## ⚙️ 环境变量

在根目录创建 `.env.local`，并设置以下变量：

```bash
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=your_anon_key

# 可选：用于 Supabase 忘记密码重定向
VITE_BASE_URL=https://506resume.vercel.app
```

> Vite 仅会注入以 `VITE_` 开头的变量。推荐在开发环境使用 `.env.local`，部署到 Vercel 时在项目 Settings → Environment Variables 中配置。

## 🚀 快速开始

```bash
pnpm install        # 安装依赖
pnpm dev            # 启动开发服务器：http://localhost:5173
pnpm build          # 生产构建
pnpm preview        # 本地预览生产包
```

## ☁️ 部署到 Vercel

1. **连接仓库**：在 [Vercel](https://vercel.com) 导入 Git 仓库，选择 `pnpm`。
2. **配置环境变量**：在 Vercel 项目 Settings 中新增：
   ```
   VITE_SUPABASE_URL=…
   VITE_SUPABASE_PUBLISHABLE_KEY=…
   VITE_BASE_URL=https://<your-domain> (可选)
   ```
3. **数据库与权限**：按照下方 `Supabase 数据模型` 建表并配置 RLS；确保部署环境的匿名 Key 拥有访问权限。
4. **验证部署**：
   - 登录后检查仪表盘是否能加载在线 + 离线列表；
   - 触发一次协作链接，确认协作者可以加入并看到实时光标；
   - 查看右上角的环境状态徽章是否显示「配置正确」。

> `vercel.json` 默认启用了静态资源缓存和对长连接友好的设置，可按需调整。

## 🗃️ Supabase 数据模型

### `resume_config`（核心简历数据）

```sql
create table public.resume_config (
  id bigint generated by default as identity primary key,
  resume_id uuid not null default gen_random_uuid(),
  user_id uuid not null default auth.uid(),
  type text default 'default',
  display_name text,
  description text,
  basics jsonb,
  job_intent jsonb,
  application_info jsonb,
  edu_background jsonb,
  work_experience jsonb,
  internship_experience jsonb,
  campus_experience jsonb,
  project_experience jsonb,
  skill_specialty jsonb,
  honors_certificates jsonb,
  self_evaluation jsonb,
  hobbies jsonb,
  "order" jsonb default '["basics","jobIntent","applicationInfo","eduBackground"]'::jsonb,
  visibility jsonb,
  document_version integer default 1,
  total_changes_count integer default 0,
  last_automerge_sync timestamptz,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

alter table public.resume_config
  add constraint resume_config_resume_id_unique unique (resume_id);

alter table public.resume_config enable row level security;

-- 每个用户只能访问自己的简历
create policy "users can read own resume"
  on public.resume_config
  for select using (auth.uid() = user_id);

create policy "users can modify own resume"
  on public.resume_config
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

-- 为 Realtime 推送包含变更前后的值
alter table public.resume_config replica identity full;
```

### `automerge_documents`（协作文档快照）

```sql
create table public.automerge_documents (
  resume_id uuid primary key references public.resume_config(resume_id) on delete cascade,
  user_id uuid not null references auth.users(id) on delete cascade,
  document_data text,         -- Automerge.save() 的 Base64
  heads jsonb,
  document_version integer default 1,
  change_count integer default 0,
  metadata jsonb,
  updated_at timestamptz default now()
);

alter table public.automerge_documents enable row level security;

create policy "owner can read document"
  on public.automerge_documents
  for select using (auth.uid() = user_id);

create policy "owner can write document"
  on public.automerge_documents
  for insert with check (auth.uid() = user_id);

create policy "owner can update document"
  on public.automerge_documents
  for update using (auth.uid() = user_id) with check (auth.uid() = user_id);
```

> `DocumentManager` 会优先使用 `metadata.documentUrl` 找回同一个 Automerge 文档；若无快照，会回退到 `resume_config` 的 JSON 字段生成默认文档。

## 🧩 协作与同步架构

1. **初始化阶段**：`DocumentManager` 优先尝试从 `automerge_documents` 拉取快照；若没有则从 `resume_config` JSON 初始化，并持久化 `documentUrl`。
2. **本地编辑流**：表单数据写入 Automerge 文档；对离线 ID（`local-*`）使用 IndexedDB；在线状态下 3 秒内聚合写入 Supabase。
3. **实时协作**：发起者点击「开启协作」后创建 session，`SupabaseNetworkAdapter` 通过 `automerge:resume:{resumeId}:{sessionId}` 频道转发 diff；协作者加入时自动导入最新快照并回放缺失变化。
4. **Presence & 光标**：`RealtimeCursors` 监听同一 `roomName`，广播鼠标坐标与昵称，实现成员标识。
5. **离线同步**：`SyncResumesDialog` 支持批量勾选本地草稿 → 云端，合并后保留历史；远端删除时根据订阅触发 toast 提示与界面刷新。

## 🧪 关键用例

- [x] 未登录创建 `local-*` 简历 → 断网编辑 → 登录后在同步对话框中勾选 → 批量迁移到云端。
- [x] 同一份简历多人实时编辑：字段级合并 + Automerge heads 确保顺序一致，协作者退出后链接立即失效。
- [x] 协作者删除或远程删除在线简历：主会话收到通知并回退到列表页，避免编辑空文档。
- [x] 手动保存与自动保存互补：Pending 状态提示 + 最近一次成功同步时间戳。

## 🛡️ 安全与权限

- 依赖 Supabase Auth（支持匿名/邮箱登录），前端只持有匿名 Key。
- `resume_config` & `automerge_documents` 均启用 RLS，限制为 `auth.uid()` 拥有者。
- `automerge_documents` 仅存储 Base64 快照 + metadata，不包含明文密码等敏感数据。
- 通过 `x-client-info` 自定义 Header 便于 Supabase 侧追踪调用来源。

## 🛠️ 常见问题

**Q: 协作者如何加入？**  
A: 发起者点击「开启协作」后复制链接，访问者需登录 Supabase 后自动加入；链接携带 `resumeId` 与 `collabSession`，对等端会导入最新快照。

**Q: 忘记密码的重置链接跳转失败？**  
A: 请在环境变量中配置 `VITE_BASE_URL`，Supabase 将把重置链接重定向至 `<BASE_URL>/editor`。

**Q: 没有 Supabase 权限时还能协作吗？**  
A: 若命中 RLS 拒绝，`DocumentManager` 会进入只读协作模式：继续接收他人广播的 Automerge diff，但本地不会再尝试持久化至云端。

## 🗺️ Roadmap

- [x] Automerge CRDT 实时协作（含分享链接、实时光标）
- [x] 离线草稿与云端同步对话框
- [ ] 正式版导出（PDF/JSON）
- [ ] 模板市场 & 多主题库
- [ ] 多语言/RTL 支持
- [ ] AI 助理：要点抽取、反馈建议
- [ ] Webhook / Edge Functions 生成版本快照

## 🤝 贡献指南

欢迎提交 Issue / PR！在提交前请确认：

1. `pnpm install` 安装依赖；
2. `pnpm exec eslint "src/**/*.{ts,tsx}"` 保持代码风格；
3. 附带必要的单元或端到端验证（若涉及核心逻辑或同步流程）；
4. 建议遵循约定式提交信息。

## 📝 License

本项目使用 **MIT** 许可证，详见 [LICENSE](./LICENSE)。
