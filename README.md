# Resume · 智能简历平台

> 一款面向个人与团队的**所见即所得（WYSIWYG）简历编辑与协作**应用：离线可用、实时同步、可扩展模板、支持多端部署。

- 在线演示（Demo）：**[https://506resume.vercel.app/](https://506resume.vercel.app/)**

## ✨ 特性

- **所见即所得编辑**：模块化区块（个人信息、教育、工作、项目、技能等），支持拖拽排序与按需显示。
- **离线优先**：使用 **IndexedDB** 持久化本地草稿，即使断网也能编辑；联网自动同步。
- **实时协作**：接入 **Supabase Realtime**，多端/多人同时编辑自动合并，延迟低、体验丝滑。
- **冲突合并策略**：字段级合并 + 删除优先（tombstone）保护，避免“互相覆盖”。
- **安全与权限**：依赖 Supabase Auth（匿名/登录）、行级安全（RLS）与最小权限访问。
- **可塑的模板系统**：以 **JSON Schema** 驱动渲染，不限语言与风格，适配校园/社招/实习等场景。
- **一键导出**：将当前视图导出为 **PDF / JSON**（保存原始数据）以便投递与备份。
- **前端工程化**：Vite + React + TypeScript + ESLint + Prettier，开发体验流畅。
- **一键部署**：内置 `vercel.json`，默认上云到 Vercel，亦可自托管。

## 🧱 技术栈

- **前端**：Vite · React · TypeScript
- **样式/组件**：Tailwind CSS · shadcn/ui（按需拉取组件）
- **数据层**：IndexedDB（本地） + Supabase（云端 Postgres / Realtime）
- **工具链**：ESLint（TypeScript 插件）· Prettier · pnpm
- **部署**：Vercel（可替换为任意静态托管或自建 Nginx）

## 📦 目录结构

```
.
├─ public/                 # 静态资源
├─ src/
│  ├─ app/                 # App 入口/路由
│  ├─ components/          # 通用组件 & 模板组件
│  ├─ features/resume/     # 简历编辑相关模块（状态、视图、逻辑）
│  ├─ lib/
│  │  ├─ db/               # IndexedDB 封装（offline-resumes）
│  │  ├─ supabase/         # 客户端 & Realtime 订阅
│  │  ├─ automerge/        # Automerge 相关逻辑
│  │  └─ schema/           # JSON Schema 与类型
│  ├─ pages/               # 页面（Demo/编辑/预览）
│  └─ styles/              # 全局样式
├─ .env.example            # 环境变量示例（见下）
├─ vite.config.ts
├─ vercel.json
├─ package.json
└─ README.md
```

## ⚙️ 环境变量

在项目根目录创建 `.env` 或 `.env.local`（Vite 只会注入以 `VITE_` 开头的变量）：

```bash
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=your_public_anon_key

# 可选：
VITE_APP_NAME=506 Resume
```

## 🚀 快速开始

```bash
# 1) 安装依赖（推荐 pnpm）
pnpm i

# 2) 本地开发
pnpm dev
# 本地地址通常为 http://localhost:5173

# 3) 生产构建
pnpm build

# 4) 本地预览生产包
pnpm preview
```

## 🗃️ 数据模型（核心表）

> 以 `resume_config` 为例：一张记录**用户简历配置与内容**的表，JSONB 存储各模块数据，配合 RLS 控制权限。

```sql
create table public.resume_config (
  id                 bigint generated by default as identity primary key,
  created_at         timestamp with time zone not null default now(),
  user_id            uuid not null default auth.uid(),
  type               text default 'default',
  basics             jsonb,
  job_intent         jsonb,
  application_info   jsonb,
  edu_background     jsonb,
  work_experience    jsonb,
  internship_experience jsonb,
  campus_experience  jsonb,
  project_experience jsonb,
  skill_specialty    jsonb,
  honors_certificates jsonb,
  self_evaluation    jsonb,
  hobbies            jsonb,
  "order"            jsonb default '["basics","jobIntent","applicationInfo","eduBackground"]'::jsonb
);

-- 为了让 Realtime UPDATE 推送包含变更前后，建议：
ALTER TABLE public.resume_config REPLICA IDENTITY FULL;
```

> 说明：
>
> - `order` 用于前端渲染顺序与显示控制；
> - 每个模块均为 `jsonb`，便于前端灵活演进；
> - 结合 RLS 与策略，可限制只能读写自己的简历。

## 🧩 离线与同步（架构与流程）

### IndexedDB 封装（离线优先）

- 数据库名称：`offline-resumes`
- 表：`resumes`（键：`resume_id`，值：基础元信息 + `data` 各模块部分字段）
- 用途：在**未登录**或**弱网**情况下本地编辑、保存草稿；登录后与云端对齐。

### 登录后合并策略（本地 ↔ 远端）

> **目标**：用户在未登录时创建/编辑的本地简历，在登录后与云端已有版本**安全合并**，尽量避免丢失。

**建议实现（字段级、可落地）**：

1. **每个字段维护元信息**：`{ value, updatedAt, deleted? }`
2. **合并规则（逐字段）**：
   - 若出现冲突（本地与远端均更新），**较新的 `updatedAt` 胜出**；
   - 删除标记优先：若一端 `deleted = true` 且时间更新更近，**以删除为准**（tombstone）；
   - `order`（渲染顺序）按**最近更新**的版本覆盖；

3. **乐观更新**：前端先应用本地写入并广播；失败再回滚/重放；
4. **幂等性**：云端按 `resume_id` + `field` 维度去重/覆盖，避免重复事件。

> 说明：该策略简单稳定、易于审计；如需更强一致性，可引入 **CRDT（如 Automerge）** 做更细粒度合并。

### Realtime 订阅（多人协作）

- 订阅目标：`resume_config` 的 `UPDATE/INSERT/DELETE`
- 过滤条件：`resume_id = ?`（或 `user_id = current_user`）
- 事件处理：
  1. 收到事件 → 合并到本地状态（按上文规则）
  2. 如激活的是当前文档，则刷新视图（最小代价重渲染）
  3. 将合并后的版本写入 IndexedDB，供离线回放

## 🧪 关键用例（E2E）

- [x] 未登录创建简历 → 断网编辑 → 恢复网络 → 登录 → 自动与云端合并
- [x] 多端同时打开同一份简历 → 互不覆盖、延迟内一致
- [x] 删除与修改冲突 → 以时间戳最近的一方为准（删除优先）
- [x] 拖拽排序与隐藏 → `order` 字段按最近更新覆盖
- [x] 导出 PDF/JSON → 与页面视图一致

## 🛡️ 安全与权限

- **RLS**：仅允许 `user_id = auth.uid()` 访问对应行；
- **最小权限**：前端仅使用 **Anon Key** 访问公开策略；
- **审计**：开启 `REPLICA IDENTITY FULL` 以便 Realtime 发送完整变更记录（更易调试合并）。

## 🔧 开发脚本

```bash
pnpm dev       # 本地开发
pnpm build     # 构建生产包
pnpm preview   # 本地预览构建产物
pnpm lint      # 代码规范检查
```

## 🛠️ 常见问题（FAQ）

**Q: 未登录可否创建并长期保存简历？**
A: 可以，数据保存在浏览器 IndexedDB。登录可选择会与云端合并并持续双向同步。

**Q: 多人协作时如何避免覆盖？**
A: 采用字段级合并 + 删除优先 + 时间戳裁决，更细粒度引入了 **Automerge** 文本型冲突解决。(TODO)

**Q: 如何只订阅某表的部分字段变化？**
A: Supabase Realtime 基于行变更推送；你可以在前端只提取需要的字段，或在云端用视图/函数裁剪。

**Q: 导出 PDF 的排版怎么保证与页面一致？**
A: 使用与页面同构的模板引擎/样式（可用 `@react-pdf/renderer` 或浏览器 `print to PDF`），保持组件单一来源。(TODO)

## 🗺️ Roadmap

- [ ] 内置更多模板与主题（校园/校招/外企/学术）
- [ ] 细粒度文本 CRDT（Automerge）与“插入/删除”级冲突解决
- [ ] 模板市场（上传/分享/一键应用）
- [ ] 多语言与RTL（从右到左）支持
- [ ] Webhook/Edge Functions：自动生成快照与版本回滚
- [ ] AI 助理：要点抽取、要素补全、风格润色与多语言翻译

## 🤝 贡献

欢迎 Issue / PR！提交前请确保：

1. 通过 `pnpm lint`；
2. 遵循约定式提交（建议）；
3. 新增/变更功能附带必要的单元/端到端用例。

## 📝 License

本项目使用 **MIT** 许可证开源。详见 [LICENSE](./LICENSE)。
